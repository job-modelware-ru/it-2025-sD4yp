@startuml
title Диаграмма деятельности: Подключение гостя (Строгая авторизация)

|Гость|
start
:Сканирует QR-код комнаты\n(или переходит по ссылке);

|Система|
:Получение ID комнаты из ссылки;

' 1. Сначала проверяем, жива ли комната
if (Комната активна?) then (нет)
  :Показать ошибку:\n"Комната закрыта или не найдена";
  stop
else (да)
  ' 2. Теперь проверяем, кто пришел
  if (Пользователь авторизован?) then (нет)
    :Перенаправление на страницу входа;
    
    |Гость|
    :Выполняет Вход или Регистрацию; 
    note right
      Согласно диаграмме
      "Регистрация и настройки"
    end note
    
    |Система|
    ' УБРАЛИ stop ЗДЕСЬ. 
    ' Теперь после входа поток идет вниз к "Регистрации участия"
  else (да)
    ' Если авторизован, просто идем дальше
  endif

  ' 3. Фиксация участия (ОБЩИЙ ЭТАП ДЛЯ ВСЕХ)
  partition "Регистрация участия" {
    if (Уже является участником?) then (нет)
      :Создать запись Connection;
      :Присвоить роль GUEST;
      :Добавить в список участников группы;
    else (да)
      :Обновить время последнего входа;
    endif
  }
  
  :Открыть интерфейс комнаты;

  |Гость|
  :Видит текущий плейлист;
  
  stop
endif
@enduml